---
import MainLayout from '../layouts/main.astro';
import AppointmentScheduler from '../components/AppointmentScheduler';
import { Toaster } from '../components/ui/sonner';
---

<MainLayout>
<div class="min-h-screen" style="background: transparent;">
<!-- Fallback für wenn React nicht lädt -->
<noscript>
  <div style="padding: 2rem; text-align: center; background: #fee2e2; color: #991b1b; border-radius: 0.5rem; margin: 2rem auto; max-width: 600px;">
    <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">JavaScript erforderlich</h2>
    <p>Bitte aktivieren Sie JavaScript, um das Terminbuchungstool zu nutzen.</p>
  </div>
</noscript>

<!-- Loading Fallback -->
<div id="loading-fallback" style="padding: 2rem; text-align: center; max-width: 600px; margin: 2rem auto;">
  <div style="display: inline-block; width: 3rem; height: 3rem; border: 4px solid #e5e7eb; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></div>
  <p style="margin-top: 1rem; color: #6b7280;">Terminbuchung wird geladen...</p>
</div>

<AppointmentScheduler client:only="react" />
<Toaster client:only="react" />
</div>
</MainLayout>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<script>
// Entferne Loading Fallback wenn React geladen ist
if (typeof window !== 'undefined') {
  window.addEventListener('load', () => {
    setTimeout(() => {
      const fallback = document.getElementById('loading-fallback');
      if (fallback) {
        fallback.style.display = 'none';
      }
    }, 1000);
  });
}

// iFrame Auto-Resize: Sende Höhen-Updates an Parent Window
(function() {
  // Prüfe ob wir in einem iFrame sind
  const isInIframe = window.self !== window.top;
  
  if (!isInIframe) return;

  function sendHeightToParent() {
    try {
      // Berechne die tatsächliche Höhe des Inhalts
      const body = document.body;
      const html = document.documentElement;
      
      const height = Math.max(
        body.scrollHeight,
        body.offsetHeight,
        html.clientHeight,
        html.scrollHeight,
        html.offsetHeight
      );

      // Sende Message an Parent Window
      window.parent.postMessage({
        type: 'resize',
        height: height
      }, '*'); // In Produktion: Ersetze '*' mit deiner Domain

    } catch (error) {
      console.error('Fehler beim Senden der Höhe:', error);
    }
  }

  // Initial senden nach Load
  window.addEventListener('load', () => {
    setTimeout(sendHeightToParent, 100);
    setTimeout(sendHeightToParent, 500);
    setTimeout(sendHeightToParent, 1000);
  });

  // Bei DOM-Änderungen
  if (typeof MutationObserver !== 'undefined') {
    const observer = new MutationObserver(() => {
      sendHeightToParent();
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
      characterData: true
    });
  }

  // Bei Resize
  if (typeof ResizeObserver !== 'undefined') {
    const resizeObserver = new ResizeObserver(() => {
      sendHeightToParent();
    });
    resizeObserver.observe(document.body);
  }

  // Fallback: Interval-basiert (alle 500ms)
  setInterval(sendHeightToParent, 500);

  // Bei Window Resize
  window.addEventListener('resize', sendHeightToParent);

  console.log('iFrame Auto-Resize aktiviert');
})();
</script>
